name: reference.aspose.net-imaging

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: staging
        type: choice
        options:
          - staging
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # New: Check disk space at the very beginning
      - name: Check disk space before anything
        if: runner.os == 'Linux'
        run: df -h || true # Use || true to prevent workflow failure if df -h itself fails

      # 0) Purge the runnerâ€™s own diag logs
      # Keep this as it directly addresses the directory in the error
      - name: Clean up runner diagnostic logs
        if: runner.os == 'Linux'
        run: sudo rm -rf /home/runner/runners/*/_diag/* || true

      # New: Check disk space after cleaning logs (optional, but helps see if it makes a difference)
      - name: Check disk space after initial log cleanup
        if: runner.os == 'Linux'
        run: df -h || true # Use || true

      # New: Check the size of the _diag directory specifically after cleanup
      - name: Check size of _diag after cleanup
        if: runner.os == 'Linux'
        run: sudo du -sh /home/runner/runners/*/_diag/ || true # Check specific path

      # 3) Sparse-checkout only the folders you need + HEAD only
      - name: Checkout only needed folders
        uses: actions/checkout@v4
        with:
          repository: Aspose/aspose.net
          token: ${{ secrets.REPO_TOKEN }}
          fetch-depth: 1
          sparse-checkout: |
            assets
            configs
            content/reference.aspose.net/imaging
            layouts
            static
            themes/docs
          sparse-checkout-cone-mode: false

      # New: Check disk space after checkout
      - name: Check disk space after checkout
        if: runner.os == 'Linux'
        run: df -h || true # Use || true

      # New: Check the size of the workspace after checkout
      - name: Check size of workspace after checkout
        if: runner.os == 'Linux'
        run: du -sh ${{ github.workspace }} || true # Check the workspace directory

      # New: Check the size of the _diag directory again before the build
      - name: Check size of _diag before build
        if: runner.os == 'Linux'
        run: sudo du -sh /home/runner/runners/*/_diag/ || true # Check again

      # 4) Prune Docker & clear /tmp
      - name: Clean up Docker & temp files
        if: runner.os == 'Linux'
        run: |
          docker system prune -af || true
          sudo rm -rf /tmp/* || true

      # New: Check disk space after cleaning Docker and temp
      - name: Check disk space after Docker and temp cleanup
        if: runner.os == 'Linux'
        run: df -h || true # Use || true

      # 5) Install Hugo
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: '0.136.0'

      # 6) Compute base URL based on environment
      - name: Determine Base URL
        id: base-url
        run: |
          if [ "${{ github.event.inputs.environment }}" = "production" ]; then
            echo "url=https://reference.aspose.net/imaging" >> $GITHUB_OUTPUT
          else
            echo "url=https://reference-qa.aspose.net/imaging" >> $GITHUB_OUTPUT
          fi

      # 7) Build the site in quiet mode
      # This is the step where the failure likely occurs
      - name: Build Aspose.Imaging
        run: |
          hugo --quiet \
            --config "./configs/reference.aspose.net/imaging.toml" \
            -b "${{ steps.base-url.outputs.url }}" \
            --cleanDestinationDir \
            --minify

      # Keep this check to see the size of the public directory (if the build completes)
      - name: Check Hugo public directory size
        run: du -sh public || true

      # New: Check disk space after build (if it completes)
      - name: Check disk space after build
        if: runner.os == 'Linux'
        run: df -h || true # Use || true

      # 8) Deploy to S3 quietly
      - name: Deploy Aspose.Imaging to S3
        run: |
          hugo deploy --quiet \
            --config "configs/reference.aspose.net/imaging.toml" \
            --maxDeletes=-1 \
            --target "${{ github.event.inputs.environment }}" \
            --force
        env:
          AWS_ACCESS_KEY_ID:     ${{ secrets.ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SECRET_ACCESS }}

      # New: Clean up the generated public directory after deployment
      # Keep this even if the error happens before it, for runs that might succeed later
      - name: Clean up Hugo public directory
        run: rm -rf public || true

      # New: Check disk space after cleaning public directory
      - name: Check disk space after cleaning public
        if: runner.os == 'Linux'
        run: df -h || true # Use || true

      # Final disk space check
      - name: Final disk space check
        if: runner.os == 'Linux'
        run: df -h || true # Use || true