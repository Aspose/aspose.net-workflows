name: reference.aspose.net-imaging
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: staging
        type: choice
        options:
          - staging
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) See how much free space we start with
      - name: Check disk usage (before)
        run: df -h

      # 2) Shallow-clone only the latest commit (fetch-depth: 1) instead of the full history
      - name: Checkout Aspose.NET (shallow)
        uses: actions/checkout@v3
        with:
          repository: Aspose/aspose.net
          token: ${{ secrets.REPO_TOKEN }}
          fetch-depth: 1

      # 3) Prune any Docker cruft and temp files to reclaim space
      - name: Clean up Docker & temp files
        if: runner.os == 'Linux'
        run: |
          docker system prune -af || true
          sudo rm -rf /tmp/* || true

      # 4) Install Hugo
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: '0.136.0'

      # 5) Compute the base URL based on the chosen environment
      - name: Determine Base URL
        id: base-url
        run: |
          if [ "${{ github.event.inputs.environment }}" = "production" ]; then
            echo "url=https://reference.aspose.net/imaging" >> $GITHUB_OUTPUT
          else
            echo "url=https://reference-qa.aspose.net/imaging" >> $GITHUB_OUTPUT
          fi

      # 6) Build the site
      - name: Build Aspose.Imaging
        run: |
          hugo \
            --config "./configs/reference.aspose.net/imaging.toml" \
            -b "${{ steps.base-url.outputs.url }}" \
            --cleanDestinationDir \
            --minify \
            --templateMetrics \
            --templateMetricsHints \
            --enableGitInfo

      # 7) Deploy to S3
      - name: Deploy Aspose.Imaging to S3
        run: |
          hugo deploy \
            --config "configs/reference.aspose.net/imaging.toml" \
            --maxDeletes=-1 \
            --target "${{ github.event.inputs.environment }}" \
            --force
        env:
          AWS_ACCESS_KEY_ID:     ${{ secrets.ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SECRET_ACCESS }}

      # 8) Check free space again to verify cleanup
      - name: Check disk usage (after)
        run: df -h
